
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼˜é€‰æ£€æµ‹ | èŠ‚ç‚¹ç”Ÿæˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        :root {
            --font-family: 'Noto Sans SC', 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius-lg: 16px;
            --border-radius-md: 12px;
            --transition-speed: 0.35s;
        }

        body.dark-theme {
            --bg-color: #0d1117;
            --bg-aurora-1: #3b82f6;
            --bg-aurora-2: #8b5cf6;
            --bg-aurora-3: #ec4899;
            --card-bg: rgba(22, 27, 34, 0.6);
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-heading: #58a6ff;
            --accent-primary: #58a6ff;
            --accent-secondary: #3fb950;
            --accent-text: #fff;
            --border-color: rgba(139, 148, 158, 0.2);
            --border-glow: rgba(88, 166, 255, 0.5);
            --input-bg: rgba(13, 17, 23, 0.6);
            --line-num-bg: rgba(13, 17, 23, 0.3);
            --line-num-text: #6e7681;
        }

        body.light-theme {
            --bg-color: #f0f2f5;
            --bg-aurora-1: #60a5fa;
            --bg-aurora-2: #c084fc;
            --bg-aurora-3: #fb7185;
            --card-bg: rgba(255, 255, 255, 0.6);
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --text-heading: #0969da;
            --accent-primary: #0969da;
            --accent-secondary: #1a7f37;
            --accent-text: #fff;
            --border-color: rgba(27, 31, 36, 0.15);
            --border-glow: rgba(9, 105, 218, 0.5);
            --input-bg: rgba(255, 255, 255, 0.8);
            --line-num-bg: rgba(240, 242, 245, 0.5);
            --line-num-text: #8c959f;
        }

        *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: 
                radial-gradient(ellipse 80% 80% at 20% 20%, var(--bg-aurora-1), transparent),
                radial-gradient(ellipse 80% 80% at 80% 20%, var(--bg-aurora-2), transparent),
                radial-gradient(ellipse 80% 80% at 50% 80%, var(--bg-aurora-3), transparent);
            opacity: 0.25;
            animation: aurora 20s linear infinite;
        }

        @keyframes aurora {
            0% { transform: rotate(0deg) scale(1.5); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1.5); }
        }

        #init-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 20000;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        .page-wrapper {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: calc(100vh - 40px);
            opacity: 0; 
            transition: opacity 0.5s ease;
        }
        
        .page-wrapper.visible { opacity: 1 !important; }

        .top-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
            height: 50px;
            width: 100%;
            flex-shrink: 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-primary), var(--bg-aurora-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: 1px;
            margin: 0;
        }

        #theme-toggle, .telegram-link {
            position: absolute;
            top: 5px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all var(--transition-speed) ease;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }

        #theme-toggle { right: 0; }
        .telegram-link { left: 0; text-decoration: none; }

        #theme-toggle:hover, .telegram-link:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--border-glow);
            color: var(--accent-primary);
        }

        /* Login specific CSS - Fixed Display */
        .login-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-grow: 1;
        }
        
        .login-view.active {
            display: flex !important;
        }

        .qr-box {
            background: #fff;
            padding: 10px;
            border-radius: 12px;
            display: inline-block;
            margin: 20px 0;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .qr-img { width: 180px; height: 180px; display: block; }
        .qr-status { color: var(--text-secondary); font-size: 14px; min-height: 20px; margin-bottom: 10px; text-align: center; }
        
        .qr-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.95);
            display: flex; align-items: center; justify-content: center;
            color: #ef4444; font-weight: bold;
            border-radius: 8px; text-align: center;
            z-index: 10;
        }

        /* View Section CSS */
        .view-section {
            display: none; 
            width: 100%;
            animation: slideUp 0.4s ease-out;
        }
        
        .view-section.active {
            display: block;
        }

        #landingView.active {
            display: flex !important;
            flex-grow: 1;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 15vh;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .landing-content {
            flex-direction: column;
            width: 100%;
            padding-bottom: 50px; 
            animation: fadeIn 0.5s ease-out;
        }

        .landing-btns {
            display: flex;
            flex-direction: column;
            gap: 25px;
            width: 100%;
            max-width: 300px;
            align-items: stretch;
        }

        .btn-landing {
            padding: 20px;
            border-radius: var(--border-radius-lg);
            border: none;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-landing:hover {
            transform: translateY(-5px) scale(1.02);
            filter: brightness(1.1);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .btn-gen-mode {
            background: linear-gradient(135deg, #f59e0b, #d946ef);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-verify-mode {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-app-mode {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            padding: 24px;
            transition: all var(--transition-speed) ease;
            margin-bottom: 20px;
        }

        .back-nav-bar {
            display: flex;
            justify-content: center; 
            align-items: center;
            margin-bottom: 15px; 
            width: 100%;
            position: relative;
        }

        .btn-back-floating {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-glow);
            color: var(--text-heading);
            padding: 8px 24px; 
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn-back-floating:hover {
            background: var(--accent-primary);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.4);
        }

        .editor-container {
            display: flex;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            height: 350px; 
        }
        
        .editor-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--border-glow);
        }
        
        .line-numbers, textarea {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 24px;
            padding: 15px 0;
            margin: 0;
            border: none;
            resize: none;
            background: transparent;
            height: 100%;
        }

        .line-numbers {
            width: 50px;
            text-align: right;
            padding-right: 12px;
            color: var(--line-num-text);
            background: var(--line-num-bg);
            border-right: 1px solid var(--border-color);
            user-select: none;
            white-space: pre-wrap;
            overflow: hidden; 
        }
        
        textarea {
            flex: 1;
            color: var(--text-primary);
            padding-left: 12px;
            padding-right: 12px;
            outline: none;
            white-space: pre;
            overflow-y: scroll;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        .btns { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
        
        button.btn-action { 
            flex: 1; 
            padding: 12px 20px; 
            border-radius: var(--border-radius-md); 
            border: none; 
            font-weight: 600; 
            color: var(--accent-text); 
            cursor: pointer; 
            transition: all 0.2s; 
            font-size: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            letter-spacing: 0.5px;
            min-width: 90px; 
            background-image: linear-gradient(45deg, var(--accent-primary), #3182CE 100%);
            box-shadow: 0 4px 15px 0 rgba(49, 130, 206, 0.25);
        }
        
        button.btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(49, 130, 206, 0.3);
            filter: brightness(1.1);
        }

        #btnScan { background-image: linear-gradient(135deg, #0ea5e9, #3b82f6); }
        #btnSub { background-image: linear-gradient(135deg, #8b5cf6, #d946ef); }
        
        #btnClear { 
            background: var(--input-bg); 
            color: var(--text-secondary); 
            flex: 0 0 60px; 
            min-width: 60px;
            border: 1px solid var(--border-color);
            box-shadow: none;
        }
        #btnClear:hover { background: var(--border-color); color: var(--text-primary); }

        .stats { 
            text-align: center; 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 15px; 
            display: flex; 
            justify-content: space-between; 
            padding: 0 10px;
            font-weight: 500;
        }
        .stat-val { color: var(--accent-primary); font-weight: bold; margin-left: 5px; }

        .table-responsive {
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
            background: var(--card-bg);
            overflow-x: auto; 
            backdrop-filter: blur(10px);
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead { background: var(--input-bg); }
        th { text-align: left; padding: 14px 16px; color: var(--text-secondary); font-size: 13px; font-weight: 600; white-space: nowrap; letter-spacing: 0.5px; text-transform: uppercase; }
        th:first-child { padding-left: 24px; }
        
        tbody tr { border-bottom: 1px solid var(--border-color); transition: background 0.15s; cursor: pointer; }
        tbody tr:last-child { border-bottom: none; }
        tbody tr:hover { background: rgba(56, 189, 248, 0.1); }
        
        td { padding: 14px 16px; font-size: 14px; color: var(--text-primary); vertical-align: middle; }
        td:first-child { padding-left: 24px; color: var(--text-secondary); font-family: monospace; }

        .ip-cell { font-family: 'Menlo', 'Monaco', monospace; font-weight: 600; color: var(--text-heading); }
        .colo-badge { border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 12px; padding: 2px 8px; border-radius: 6px; background: var(--input-bg); font-weight: 600; }
        
        .lat-badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; min-width: 60px; text-align: center; display: inline-block; }
        .fast { color: #34d399; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
        .mid { color: #facc15; background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.2); }
        .slow { color: #f87171; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }

        .check-icon { font-size: 16px; display: block; width: 100%; text-align: center; }
        .cross-icon { font-size: 18px; color: var(--text-secondary); display: block; width: 100%; text-align: center; line-height: 1; opacity: 0.5; }

        .bottom-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 380px;
            background: var(--card-bg); backdrop-filter: blur(16px);
            border: 1px solid var(--border-glow);
            padding: 8px; border-radius: 50px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            display: none; z-index: 100;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: translateX(-50%) scale(0.8); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
        
        .bottom-actions { display: flex; gap: 10px; width: 100%; }
        .btn-copy-all {
            flex: 1; padding: 12px; border-radius: 30px; border: none;
            background: #10b981; color: white; font-weight: 700; font-size: 14px;
            cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-copy-all:hover { background: #059669; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 9999; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--card-bg); border: 1px solid var(--border-color);
            width: 90%; max-width: 450px; border-radius: 16px; padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: modalPop 0.3s ease-out;
            max-height: 90vh; overflow-y: auto;
            margin: auto;
        }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .modal-title { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close-btn { background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; line-height: 1; }
        
        .modal-input {
            width: 100%; background: var(--input-bg); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 12px; border-radius: 8px; outline: none; margin-bottom: 15px;
            font-size: 14px;
            text-align: center; 
            text-align-last: center;
        }
        .modal-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--border-glow); }

        select.modal-input { cursor: pointer; }
        select.modal-input option { background: #1e293b; color: #fff; text-align: left; }
        
        .filter-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .filter-group label { display: flex; align-items: center; gap: 6px; color: var(--text-secondary); font-size: 14px; cursor: pointer; }
        .filter-group input[type="checkbox"] { accent-color: var(--accent-primary); width: 16px; height: 16px; cursor: pointer; }

        .modal-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn-cancel { background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); flex: 1; }
        .btn-confirm { background: var(--accent-primary); color: #fff; border: none; flex: 1; }
        
        .modal-actions button.btn-confirm {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            line-height: 1.3;
            min-height: 50px;
        }
        .modal-actions button.btn-confirm span:first-child { font-size: 15px; font-weight: 700; }
        .modal-actions button.btn-confirm span:last-child { font-size: 12px; font-weight: normal; opacity: 0.9; }

        .gen-label { color: var(--text-secondary); font-size: 13px; margin-bottom: 5px; display: block; }
        .gen-result-box { 
            position: relative; margin-top: 20px; 
            border: 2px dashed var(--border-color); border-radius: 8px; padding: 5px;
            background: var(--input-bg);
        }
        .gen-result-input { 
            width: 100%; border: none; background: transparent; color: var(--accent-primary); 
            padding: 10px; font-family: monospace; font-size: 12px; outline: none;
        }
        .btn-copy-res {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            padding: 5px 12px; background: var(--card-bg); font-size: 12px; border-radius: 4px; color: var(--text-primary); border: 1px solid var(--border-color); cursor: pointer;
        }
        
        .gen-status-box {
            background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);
            color: #34d399; padding: 12px; border-radius: 8px; text-align: center;
            font-weight: 600; font-size: 14px; margin-bottom: 15px;
            display: none; align-items: center; justify-content: center; gap: 8px;
        }

        #toast-container { position: fixed; top: 70px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            padding: 12px 20px; border-radius: 10px; color: #fff; font-weight: 600; font-size: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0; transform: translateY(-20px);
            display: flex; align-items: center; gap: 8px;
        }
        .toast.hide { animation: toastOut 0.4s ease forwards; }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { to { opacity: 0; transform: translateY(-30px); } }

        .custom-format-container { display: flex; align-items: center; gap: 5px; }
        #customProxyFormat { flex: 1; }
        .btn-reset-format { 
            padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); 
            color: var(--text-secondary); cursor: pointer; border-radius: 8px;
        }
        .btn-reset-format:hover { color: var(--text-primary); border-color: var(--accent-primary); }

        .manual-text-info { 
            text-align: center; 
            margin: 30px 0 15px; 
            color: var(--text-secondary); 
            font-size: 14px; 
            line-height: 1.6; 
        }
        .manual-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-top: 10px; 
        }
        .manual-card { 
            background: var(--input-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 15px; 
            font-size: 13px; 
        }
        .manual-title { 
            font-weight: 700; 
            color: var(--accent-primary); 
            margin-bottom: 12px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px; 
            font-size: 1.1em;
        }
        .c-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 4px 0; 
            border-bottom: 1px solid rgba(128,128,128,0.1);
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 4px;
        }
        .c-row:hover { background: rgba(255,255,255,0.05); }
        .c-lbl { 
            font-weight: 600; 
            color: var(--text-primary); 
            white-space: nowrap; 
            margin-right: 10px; 
        }
        .c-val { 
            text-align: right; 
            word-break: break-all; 
            color: var(--text-secondary); 
            font-family: monospace;
        }
        
        .app-list-item {
            display: flex; flex-direction: column; padding: 1rem;
            border: 1px solid var(--border-color); border-radius: var(--border-radius-md);
            margin-bottom: 1rem; background: var(--input-bg);
        }
        .app-name { font-size: 1.1em; font-weight: 600; color: var(--text-heading); margin-bottom: 0.5rem; }
        .app-links a {
            display: block; color: var(--accent-primary); text-decoration: none;
            margin-top: 0.5rem; word-break: break-all; font-size: 0.95em;
        }
        .app-links a:hover { text-decoration: underline; filter: brightness(1.2); }
        .app-links span { color: var(--text-secondary); font-size: 0.9em; }
        
        .platform-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;
        }
        
        @media (max-width: 600px) { 
            body { padding: 10px; } 
            h1 { font-size: 24px; padding: 0 10px; }
            .editor-container { height: 220px; }
            .btns { flex-wrap: wrap; }
            #btnClear { flex: 1; }
            .manual-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="dark-theme">

<div id="init-overlay">
    <div style="text-align:center; color: var(--accent-primary);">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
    </div>
</div>

<div class="page-wrapper" id="mainWrapper">
    <div class="top-bar">
        <a href="https://t.me/crow187" target="_blank" class="telegram-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 2 L11 13 L2 9 L22 2 Z M22 2 L15 22 L11 13 L2 9 L22 2 Z" fill="var(--text-heading)"></path>
            </svg>
        </a>
        <h1 class="logo" id="pageTitle">ä¼˜é€‰æ£€æµ‹ | èŠ‚ç‚¹ç”Ÿæˆ</h1>
        <button id="theme-toggle">ğŸŒ</button>
    </div>

    <!-- Login View -->
    <div id="loginView" class="login-view">
        <div class="card" style="text-align:center;width:100%;max-width:360px">
            <h3 style="margin-top:0;color:var(--text-heading);border-bottom:1px solid var(--border-color);padding-bottom:15px;margin-bottom:20px">ğŸ§ QQ å®‰å…¨ç™»å½•</h3>
            <div id="qrContainer" class="qr-box" onclick="getQR()" title="ç‚¹å‡»åˆ·æ–°äºŒç»´ç ">
                 <div style="width:180px;height:180px;display:flex;align-items:center;justify-content:center;color:#000">åŠ è½½ä¸­...</div>
            </div>
            <div id="qrStatus" class="qr-status">è¯·ä½¿ç”¨æ‰‹æœº QQ æ‰«ç </div>
        </div>
    </div>

    <!-- Main Views (Protected) -->
    <div id="protectedContent" style="display:none; width: 100%; flex-grow: 1; flex-direction: column;">
        <div id="landingView" class="landing-content view-section active">
            <div class="landing-btns">
                <button class="btn-landing btn-gen-mode" onclick="openNotifyModal()">
                    <span>ğŸš€ ç”ŸæˆèŠ‚ç‚¹</span>
                </button>
                <button class="btn-landing btn-verify-mode" onclick="switchToVerify()">
                    <span>âš¡ éªŒè¯ I P</span>
                </button>
                <button class="btn-landing btn-app-mode" onclick="openAppSelection()">
                    <span>ğŸ“± APP ä¸‹è½½</span>
                </button>
            </div>
        </div>

        <div id="verifyView" class="view-section">
            <div class="card">
                <div class="editor-container">
                    <div id="lineNumbers" class="line-numbers">1</div>
                    <textarea id="input" placeholder="è¯·ç²˜è´´ IP:ç«¯å£ ã€ åŸŸå:ç«¯å£&#10;æ”¯æŒæ ¼å¼ï¼š&#10;1.1.1.1:443&#10;google.com:443" wrap="off"></textarea>
                </div>
                <div class="btns">
                    <button class="btn-action" id="btnScan" onclick="scan()">ğŸš€ å¼€å§‹æ‰«æ</button>
                    <button class="btn-action" id="btnSub" onclick="openModal()">ğŸ“¥ è®¢é˜…æå–</button>
                    <button class="btn-action" id="btnBack" onclick="goBackToHome()">â†©ï¸ è¿”å›ä¸»é¡µ</button>
                    <button class="btn-action" id="btnClear" onclick="clearAll()">ğŸ—‘ï¸</button>
                </div>
                <div class="stats">
                    <span>çŠ¶æ€: <span id="status" style="color:var(--text-secondary)">å°±ç»ª</span></span>
                    <span>æœ‰æ•ˆèŠ‚ç‚¹: <span id="validCount" class="stat-val">0</span></span>
                </div>
            </div>

            <div class="card" id="tableBox" style="display:none; padding:0;">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th width="40">#</th>
                                <th>IP:ç«¯å£</th>
                                <th>åœ°åŒº</th>
                                <th>å»¶è¿Ÿ</th>
                                <th style="text-align:center">ProxyIP</th>
                                <th style="text-align:center">åä»£IP</th>
                            </tr>
                        </thead>
                        <tbody id="list"></tbody>
                    </table>
                </div>
            </div>
            <div id="emptyMsg" style="text-align:center;padding:50px;color:var(--text-secondary);display:none;font-style:italic;">æœªå‘ç°æœ‰æ•ˆèŠ‚ç‚¹</div>
        </div>

        <div id="generateView" class="view-section">
            
            <div class="back-nav-bar">
                <button class="btn-back-floating" onclick="goBackToHome()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    è¿”å›ä¸»èœå•
                </button>
            </div>

            <div class="card">
                <select id="genRegionSelect" class="modal-input" onchange="handleGenShortcut()">
                    <option value="">-- å¿«é€Ÿé€‰æ‹©åœ°åŒº (éªŒè¯å¹¶ç”Ÿæˆ) --</option>
                </select>
                <div id="genStatusBox" class="gen-status-box"></div>

                <span class="gen-label">HOST</span>
                <input type="text" id="genHost" class="modal-input" placeholder="è‡ªåŠ¨è·å–...">
                
                <span class="gen-label">UUID</span>
                <input type="text" id="genUuid" class="modal-input" placeholder="è‡ªåŠ¨è·å–...">
                
                <div id="formatGroup" style="display:none; animation: fadeIn 0.3s ease;">
                    <span class="gen-label" style="color:var(--accent-primary)">ä½ ä»£ç æ”¯æŒçš„Proxyipæ ¼å¼</span>
                    <select id="proxyFormat" class="modal-input" onchange="handleFormatChange()">
                        <option value="/proxyip.">/proxyip.</option>
                        <option value="/proxyip=">/proxyip=</option>
                        <option value="/proxy.">/proxy.</option>
                        <option value="/proxy=">/proxy=</option>
                        <option value="/ip.">/ip.</option>
                        <option value="/ip=">/ip=</option>
                        <option value="custom">è‡ªå®šä¹‰ (æ‰‹åŠ¨è¾“å…¥)</option>
                    </select>
                    <div id="customFormatBox" class="custom-format-container" style="display:none;">
                        <input type="text" id="customProxyFormat" class="modal-input" placeholder="è¾“å…¥pathçš„Proxyipæ ¼å¼" style="margin-bottom:0;">
                        <button class="btn-reset-format" onclick="resetFormatSelect()" title="é‡ç½®é€‰æ‹©">â†©ï¸</button>
                    </div>
                </div>
                
                <span class="gen-label">ç”Ÿæˆæ•°é‡é™åˆ¶</span>
                <select id="genLimit" class="modal-input">
                    <option value="10">ç”Ÿæˆä¸Šé™ 10 ä¸ªèŠ‚ç‚¹</option>
                    <option value="20" selected>ç”Ÿæˆä¸Šé™ 20 ä¸ªèŠ‚ç‚¹</option>
                    <option value="30">ç”Ÿæˆä¸Šé™ 30 ä¸ªèŠ‚ç‚¹</option>
                    <option value="40">ç”Ÿæˆä¸Šé™ 40 ä¸ªèŠ‚ç‚¹</option>
                    <option value="50">ç”Ÿæˆä¸Šé™ 50 ä¸ªèŠ‚ç‚¹</option>
                </select>

                <div class="modal-actions">
                    <button class="btn-action btn-confirm" onclick="generateSub('vless')" style="background:#3b82f6">
                        <span>Vless</span><span>è®¢é˜…</span>
                    </button>
                    <button class="btn-action btn-confirm" onclick="generateSub('trojan')" style="background:#ec4899">
                        <span>Trojan</span><span>è®¢é˜…</span>
                    </button>
                    <button class="btn-action btn-confirm" onclick="generateSub('ss')" style="background:#10b981">
                        <span>SS</span><span>è®¢é˜…</span>
                    </button>
                </div>

                <div class="gen-result-box">
                    <input type="text" id="genResult" class="gen-result-input" readonly placeholder="è®¢é˜…åœ°å€å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...">
                    <button class="btn-copy-res" onclick="copyGenResult()">å¤åˆ¶</button>
                </div>

                <div class="manual-text-info">
                    æœ¬é¡µé¢é»˜è®¤çš„Snippets å’Œ Pages æ”¯æŒäº”ç§åè®®<br>
                    ä»¥ä¸Šè®¢é˜…æ”¯æŒ3ç§åè®®ï¼Œä»¥ä¸‹æ˜¯2ç§æ‰‹åŠ¨æ·»åŠ åè®®
                </div>
                <div class="manual-grid">
                    <div class="manual-card">
                        <div class="manual-title">HTTPåè®® (æ‰‹åŠ¨é…ç½®)</div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">åˆ«å(remarks):</span><span class="c-val dynamic-remark">CMä¼˜é€‰åŸŸå</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">åœ°å€(address):</span><span class="c-val dynamic-addr">cf.090227.xyz</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ç«¯å£(port):</span><span class="c-val dynamic-port">443</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ç”¨æˆ·(User):</span><span class="c-val"></span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">å¯†ç (Pass):</span><span class="c-val"></span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ è¾“åè®®(network):</span><span class="c-val">ws</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ªè£…ç±»å‹(type):</span><span class="c-val">none</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ªè£…åŸŸå(host):</span><span class="c-val dynamic-host">snippets.kkii.eu.org</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">è·¯å¾„(path):</span><span class="c-val dynamic-path">/</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ è¾“å±‚å®‰å…¨(TLS):</span><span class="c-val">tls</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">SNI:</span><span class="c-val dynamic-host">snippets.kkii.eu.org</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">Fingerprint:</span><span class="c-val">chrome</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">è·³è¿‡è¯ä¹¦éªŒè¯:</span><span class="c-val">false</span></div>
                    </div>
                    <div class="manual-card">
                        <div class="manual-title">SOCKS5åè®® (æ‰‹åŠ¨é…ç½®)</div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">åˆ«å(remarks):</span><span class="c-val dynamic-remark">CMä¼˜é€‰åŸŸå</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">åœ°å€(address):</span><span class="c-val dynamic-addr">cf.090227.xyz</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ç«¯å£(port):</span><span class="c-val dynamic-port">443</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ç”¨æˆ·(User):</span><span class="c-val"></span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">å¯†ç (Pass):</span><span class="c-val"></span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ è¾“åè®®(network):</span><span class="c-val">ws</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ªè£…ç±»å‹(type):</span><span class="c-val">none</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ªè£…åŸŸå(host):</span><span class="c-val dynamic-host">snippets.kkii.eu.org</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">è·¯å¾„(path):</span><span class="c-val dynamic-path">/</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">ä¼ è¾“å±‚å®‰å…¨(TLS):</span><span class="c-val">tls</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">SNI:</span><span class="c-val dynamic-host">snippets.kkii.eu.org</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">Fingerprint:</span><span class="c-val">chrome</span></div>
                        <div class="c-row" onclick="copyVal(this)"><span class="c-lbl">è·³è¿‡è¯ä¹¦éªŒè¯:</span><span class="c-val">false</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="bottomBar" class="bottom-bar">
        <div class="bottom-actions">
            <button class="btn-copy-all" onclick="copyAll()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                å¤åˆ¶å…¨éƒ¨æœ‰æ•ˆèŠ‚ç‚¹
            </button>
        </div>
    </div>

</div>

<div id="subModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">
            <span>ğŸ“¥ è®¢é˜…æå–</span>
            <button class="modal-close-btn" onclick="closeModal()">Ã—</button>
        </div>
        <select id="regionSelect" class="modal-input" onchange="handleRegionChange()">
            <option value="">-- å¿«é€Ÿé€‰æ‹©åœ°åŒº --</option>
        </select>
        <input type="text" id="subUrl" class="modal-input" placeholder="è¯·è¾“å…¥è®¢é˜…é“¾æ¥ / èŠ‚ç‚¹æ–‡æœ¬">
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-confirm" id="btnExtract" onclick="fetchSub()">ç«‹å³æå–</button>
        </div>
    </div>
</div>

<div id="appSelectModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">
            <span>ğŸ“± é€‰æ‹©å®¢æˆ·ç«¯å¹³å°</span>
            <button class="modal-close-btn" onclick="closeAppSelect()">Ã—</button>
        </div>
        <div class="platform-grid">
            <button class="btn-action" onclick="openAppList('android')">ğŸ¤– Android</button>
            <button class="btn-action" onclick="openAppList('ios')">ğŸ iOS</button>
            <button class="btn-action" onclick="openAppList('windows')">ğŸ’» Windows</button>
            <button class="btn-action" onclick="openAppList('mac')">ğŸ macOS</button>
        </div>
    </div>
</div>

<div id="appListModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">
            <span id="appListTitle">APP ä¸‹è½½</span>
            <button class="modal-close-btn" onclick="closeAppList()">Ã—</button>
        </div>
        <div id="appListBody"></div>
    </div>
</div>

<div id="notifyModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">
            <span>ğŸ“¢ å…¬å‘Š</span>
            <button class="modal-close-btn" onclick="closeNotifyModal()">Ã—</button>
        </div>
        <div id="notifyContent" style="margin-bottom:20px;line-height:1.6;color:var(--text-secondary)"></div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="agreeNotify()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<div id="disclaimerModal" class="modal-overlay" style="z-index: 20001;">
    <div class="modal-content">
        <div class="modal-title" style="color: #ef4444;">
            <span>âš ï¸ å…è´£å£°æ˜</span>
        </div>
        <div id="disclaimerContent" style="margin-bottom:20px;line-height:1.6;color:var(--text-secondary);max-height:60vh;overflow-y:auto;"></div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="closeDisclaimer()" style="background:#ef4444">æˆ‘å·²é˜…è¯»å¹¶åŒæ„</button>
        </div>
    </div>
</div>

<div id="noDataModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">
            <span>âš ï¸ æš‚æ— æ•°æ®</span>
            <button class="modal-close-btn" onclick="closeNoDataModal()">Ã—</button>
        </div>
        <p style="color:var(--text-secondary);margin-bottom:20px;">è¯¥åœ°åŒºæš‚æ—¶æ²¡æœ‰å¯ç”¨èŠ‚ç‚¹ï¼Œè¯·å‰å¾€æºç«™è·å–æœ€æ–°æ•°æ®ã€‚</p>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeNoDataModal()">å…³é—­</button>
            <button class="btn-confirm" onclick="goToScanSite()">å‰å¾€æºç«™</button>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script>
    const API_URL = "/batch"; 
    const FETCH_URL = "/fetch";
    const STORE_URL = "/store";
    let validList = [];
    let currentRegionName = ""; 
    const toastColors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'];
    
    let GlobalHost = "";
    let GlobalUUID = "";
    let PUBLIC_CONFIG = {};

    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    
    function setTheme(theme){
        if(theme==='light'){
            body.classList.remove('dark-theme');
            body.classList.add('light-theme');
            themeToggle.textContent='ğŸŒ™';
        }else{
            body.classList.remove('light-theme');
            body.classList.add('dark-theme');
            themeToggle.textContent='ğŸŒ';
        }
    }
    
    themeToggle.addEventListener('click',()=>{
        const isDark = body.classList.contains('dark-theme');
        const newTheme = isDark?'light':'dark';
        setTheme(newTheme);
        localStorage.setItem('theme',newTheme);
    });
    
    const savedTheme = localStorage.getItem('theme')||'dark';
    setTheme(savedTheme);

    const landingView = document.getElementById('landingView');
    const verifyView = document.getElementById('verifyView');
    const generateView = document.getElementById('generateView');
    const pageTitle = document.getElementById('pageTitle');
    const notifyModal = document.getElementById('notifyModal');
    const disclaimerModal = document.getElementById('disclaimerModal');
    const noDataModal = document.getElementById('noDataModal');
    const initOverlay = document.getElementById('init-overlay');
    const mainWrapper = document.getElementById('mainWrapper');
    const appSelectModal = document.getElementById('appSelectModal');
    const appListModal = document.getElementById('appListModal');
    
    /* Login Logic Variables */
    let loginTimer, qrsig;
    const loginView = document.getElementById('loginView');
    const protectedContent = document.getElementById('protectedContent');
    const qrContainer = document.getElementById('qrContainer');
    const qrStatus = document.getElementById('qrStatus');

    function hideAllViews() {
        landingView.classList.remove('active');
        verifyView.classList.remove('active');
        generateView.classList.remove('active');
        const bottomBar = document.getElementById('bottomBar');
        if(bottomBar) bottomBar.style.display = 'none';
    }

    function resetViews() {
        clearAll(); 
        document.getElementById('genHost').value = "";
        document.getElementById('genUuid').value = "";
        document.getElementById('genResult').value = "";
        document.getElementById('genStatusBox').style.display = 'none';
        document.getElementById('genRegionSelect').style.display = 'block';
        document.getElementById('genRegionSelect').value = "";
        resetFormatSelect();
        document.getElementById('formatGroup').style.display = 'none';
    }

    function goBackToHome() {
        resetViews(); 
        hideAllViews();
        landingView.classList.add('active');
        pageTitle.innerText = "ä½ è¦ä½¿ç”¨ï¼Ÿ";
        applyPreset();
    }

    function switchToVerify() {
        resetViews(); 
        hideAllViews();
        verifyView.classList.add('active');
        pageTitle.innerText = "Proxyip éªŒè¯";
        const bottomBar = document.getElementById('bottomBar');
        if(validList.length > 0 && bottomBar) bottomBar.style.display = 'block';
    }

    function switchToGenerate() {
        resetViews(); 
        hideAllViews();
        generateView.classList.add('active');
        pageTitle.innerText = "ç”Ÿæˆè®¢é˜…èŠ‚ç‚¹";
        applyPreset(); 
    }

    function openNotifyModal() {
        if(PUBLIC_CONFIG.popup2_open) {
            document.getElementById('notifyContent').innerHTML = PUBLIC_CONFIG.popup2_content;
            notifyModal.style.display = 'flex';
        } else {
            switchToGenerate();
        }
    }
    function closeNotifyModal() { notifyModal.style.display = 'none'; }
    function agreeNotify() {
        closeNotifyModal();
        switchToGenerate();
    }
    
    function closeDisclaimer() {
        disclaimerModal.style.display = 'none';
    }

    function revealMainContent() {
        if (initOverlay) {
            initOverlay.style.opacity = '0';
            setTimeout(() => {
                initOverlay.style.display = 'none';
                initOverlay.style.visibility = 'hidden';
                if(mainWrapper) mainWrapper.classList.add('visible');
            }, 500);
        }
    }

    function showNoDataModal() { noDataModal.style.display = 'flex'; }
    function closeNoDataModal() { noDataModal.style.display = 'none'; }
    function goToScanSite() {
        window.open('https://proxyip.881288.xyz/', '_blank');
        closeNoDataModal();
    }
    
    /* Login Logic */
    async function getQR() {
        clearInterval(loginTimer);
        qrContainer.innerHTML = '<div style="width:180px;height:180px;display:flex;align-items:center;justify-content:center;color:#000">åŠ è½½ä¸­...</div>';
        try {
            const r = await fetch('/auth/qr');
            const d = await r.json();
            qrsig = d.qrsig;
            qrContainer.innerHTML = `<img src="${d.image}" class="qr-img">`;
            qrStatus.innerText = 'è¯·æ‰«ç ';
            checkLogin();
        } catch { qrStatus.innerText = 'ç½‘ç»œé”™è¯¯'; }
    }
    
    function checkLogin() {
        loginTimer = setInterval(async () => {
            try {
                const r = await fetch('/auth/check', {method:'POST', body:JSON.stringify({qrsig})});
                const d = await r.json();
                if(d.code === 0) {
                    clearInterval(loginTimer);
                    qrStatus.innerText = 'ç™»å½•æˆåŠŸ';
                    location.reload();
                } else if (d.code === 403) {
                     clearInterval(loginTimer);
                     alert(d.msg);
                     if(d.redirect) location.href = d.redirect;
                     else getQR();
                } else if (d.code === 66) qrStatus.innerText = 'ç­‰å¾…ç¡®è®¤...';
                else if (d.code === 67) qrStatus.innerText = 'è¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤';
                else if (d.code === 65) {
                    clearInterval(loginTimer);
                    qrContainer.innerHTML += '<div class="qr-overlay" onclick="getQR();event.stopPropagation()">å·²è¿‡æœŸ<br>ç‚¹å‡»åˆ·æ–°</div>';
                    qrStatus.innerText = 'äºŒç»´ç å·²è¿‡æœŸ';
                }
            } catch {}
        }, 2000);
    }
    
    function showLogin() {
        loginView.classList.add('active');
        protectedContent.style.display = 'none';
        getQR();
    }
    
    function showApp() {
        loginView.classList.remove('active');
        protectedContent.style.display = 'flex';
        
        // Show disclaimer if needed
        if (PUBLIC_CONFIG.popup1_open) {
            setTimeout(() => {
                document.getElementById('disclaimerContent').innerHTML = PUBLIC_CONFIG.popup1_content;
                disclaimerModal.style.display = 'flex';
            }, 600);
        }
    }

    /* APP Download Logic */
    function openAppSelection() {
        appSelectModal.style.display = 'flex';
    }
    function closeAppSelect() {
        appSelectModal.style.display = 'none';
    }
    
    const downloadData={android:[{name:'Clash-Mi',repo:'KaringX/clashmi',keywords:['android','arm64-v8a.apk']},{name:'Karing',repo:'KaringX/karing',keywords:['apk','universal-release']},{name:'Sing-Box',repo:'SagerNet/sing-box',keywords:['android','universal']},{name:'V2rayNG',repo:'2dust/v2rayNG',keywords:['apk','arm64-v8a']}],ios:[{name:'Karing',fixedUrl:'https://apps.apple.com/us/app/karing/id6472431552?platform=iphone'},{name:'Sing-Box',fixedUrl:'https://apps.apple.com/us/app/sing-box-vt/id6673731168?platform=iphone'},{name:'Shadowrocket',fixedUrl:'https://apps.apple.com/us/app/shadowrocket/id932747118?platform=iphone'}],windows:[{name:'Clash-Mi',repo:'KaringX/clashmi',keywords:['windows','x64.zip']},{name:'Karing',repo:'KaringX/karing',keywords:['exe','x64-setup']},{name:'V2rayN',repo:'2dust/v2rayN',keywords:['windows-64.zip']},{name:'ClashN',repo:'2dust/clashN',keywords:['clashN.zip']}],mac:[{name:'Karing',fixedUrl:'https://apps.apple.com/us/app/karing/id6472431552?platform=mac'},{name:'Sing-Box',fixedUrl:'https://apps.apple.com/us/app/sing-box-vt/id6673731168?platform=mac'}]};

    function getAcceleratedUrl(url){
        if(url.includes('github.com')){
            const origin = window.location.origin;
            return origin + '/https://' + url.replace('https://','');
        }
        return url;
    }

    async function getLatestReleaseAsset(repo,keywords){
        try{
            const apiUrl = `https://api.github.com/repos/${repo}/releases/latest`;
            const response = await fetch(getAcceleratedUrl(apiUrl) + '?t=' + Date.now());
            if(!response.ok)return null;
            const data=await response.json();
            for(const keyword of keywords){
                const asset=data.assets.find(a=>a.name.toLowerCase().includes(keyword.toLowerCase()));
                if(asset)return asset.browser_download_url;
            }
            return null;
        }catch(e){return null;}
    }

    async function openAppList(platform){
        closeAppSelect();
        const platformName={android:'å®‰å“',ios:'è‹¹æœ',windows:'Windows',mac:'Mac'}[platform];
        document.getElementById('appListTitle').textContent = `${platformName}å®¢æˆ·ç«¯ä¸‹è½½`;
        const modalBody = document.getElementById('appListBody');
        modalBody.innerHTML = '<div style="text-align:center;padding:20px;color:var(--accent-primary);">â³ æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬...</div>';
        appListModal.style.display = 'flex';
        
        const apps = downloadData[platform];
        let content = '';
        
        for(const app of apps){
            let linksHtml = '';
            if(app.fixedUrl){
                linksHtml = `<a href="${getAcceleratedUrl(app.fixedUrl)}" target="_blank" rel="noopener noreferrer">ğŸ“² å‰å¾€ä¸‹è½½ (${app.fixedUrl.includes('apps.apple.com')?'AppStore':'ç›´è¿'})</a>`;
            } else if(app.repo){
                const url = await getLatestReleaseAsset(app.repo, app.keywords);
                if(url){
                    const accUrl = getAcceleratedUrl(url);
                    linksHtml = `<a href="${accUrl}" target="_blank" rel="noopener noreferrer">â¬‡ï¸ ç‚¹å‡»ä¸‹è½½ (${url.split('/').pop()})</a>`;
                } else {
                    linksHtml = '<span>âš ï¸ è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</span>';
                }
            }
            content += `<div class="app-list-item"><span class="app-name">${app.name}</span><div class="app-links">${linksHtml}</div></div>`;
        }
        modalBody.innerHTML = content;
    }
    
    function closeAppList() { appListModal.style.display = 'none'; }

    const inputArea = document.getElementById('input');
    const lineNumbers = document.getElementById('lineNumbers');
    const modal = document.getElementById('subModal');
    const subInput = document.getElementById('subUrl');
    const regionSelect = document.getElementById('regionSelect');
    const genRegionSelect = document.getElementById('genRegionSelect');
    
    const genHostInput = document.getElementById('genHost');
    const genUuidInput = document.getElementById('genUuid');
    const formatGroup = document.getElementById('formatGroup');
    const proxyFormatSelect = document.getElementById('proxyFormat');
    const customFormatBox = document.getElementById('customFormatBox');

    async function initApp() {
        try {
            const res = await fetch('/api/public/config?t=' + Date.now()).then(r => r.json());
            PUBLIC_CONFIG = res;
            
            if (res.node_data) {
                GlobalHost = res.node_data.host;
                GlobalUUID = res.node_data.uuid;
            }

            applyPreset();

            // Check Auth Logic
            if(res.qq_auth_open && !res.is_logged_in) {
                showLogin();
            } else {
                showApp();
            }
            
            revealMainContent();

        } catch (e) {
            console.error("Init failed", e);
            revealMainContent();
            showApp(); // Fallback to show app on error
        }
    }

    function applyPreset() {
        genHostInput.value = "";
        genUuidInput.value = "";
        
        const hostVal = GlobalHost || "æœªé…ç½® Host";
        const uuidVal = GlobalUUID || "æœªé…ç½® UUID";

        genHostInput.placeholder = hostVal;
        genUuidInput.placeholder = uuidVal;
        
        if(GlobalHost) {
            document.querySelectorAll('.dynamic-host').forEach(el => el.innerText = GlobalHost);
        } else {
            document.querySelectorAll('.dynamic-host').forEach(el => el.innerText = "æœªé…ç½®");
        }
        
        checkCustomMode();
    }

    function checkCustomMode() {
        if(genHostInput.value.trim() !== "" || genUuidInput.value.trim() !== "") {
            formatGroup.style.display = 'block';
        } else {
            formatGroup.style.display = 'none';
            resetFormatSelect();
        }
    }

    function handleFormatChange() {
        if (proxyFormatSelect.value === 'custom') {
            proxyFormatSelect.style.display = 'none';
            customFormatBox.style.display = 'flex';
            document.getElementById('customProxyFormat').focus();
        } else {
            proxyFormatSelect.style.display = 'block';
            customFormatBox.style.display = 'none';
        }
    }

    function resetFormatSelect() {
        proxyFormatSelect.value = "/proxyip.";
        proxyFormatSelect.style.display = 'block';
        customFormatBox.style.display = 'none';
        document.getElementById('customProxyFormat').value = "";
    }
    
    function updateManualConfig(ip, port, region) {
        const remark = `${region}ï¼ˆåä»£IPï¼‰`;
        document.querySelectorAll('.dynamic-remark').forEach(el => el.innerText = remark);
        document.querySelectorAll('.dynamic-addr').forEach(el => el.innerText = ip);
        document.querySelectorAll('.dynamic-port').forEach(el => el.innerText = port);
        document.querySelectorAll('.dynamic-path').forEach(el => el.innerText = `/${ip}:${port}`);
    }
    
    function resetManualConfig() {
        document.querySelectorAll('.dynamic-remark').forEach(el => el.innerText = 'CMä¼˜é€‰åŸŸå');
        document.querySelectorAll('.dynamic-addr').forEach(el => el.innerText = 'cf.090227.xyz');
        document.querySelectorAll('.dynamic-port').forEach(el => el.innerText = '443');
        document.querySelectorAll('.dynamic-path').forEach(el => el.innerText = '/');
        document.querySelectorAll('.dynamic-host').forEach(el => el.innerText = GlobalHost || 'æœªé…ç½®');
    }

    function copyVal(row) {
        const valSpan = row.querySelector('.c-val');
        if (valSpan) {
            const text = valSpan.innerText;
            if (text) {
                copyText(text);
            }
        }
    }

    genHostInput.addEventListener('input', checkCustomMode);
    genUuidInput.addEventListener('input', checkCustomMode);

    const regionsData = [
        {name: "é¦™æ¸¯", url: "https://proxyip.881288.xyz/api/txt/HK"},
        {name: "å°æ¹¾", url: "https://proxyip.881288.xyz/api/txt/TW"},
        {name: "æ—¥æœ¬", url: "https://proxyip.881288.xyz/api/txt/JP"},
        {name: "éŸ©å›½", url: "https://proxyip.881288.xyz/api/txt/KR"},
        {name: "æ–°åŠ å¡", url: "https://proxyip.881288.xyz/api/txt/SG"},
        {name: "ç¾å›½", url: "https://proxyip.881288.xyz/api/txt/US"},
        {name: "é©¬æ¥è¥¿äºš", url: "https://proxyip.881288.xyz/api/txt/MY"},
        {name: "æ³°å›½", url: "https://proxyip.881288.xyz/api/txt/TH"},
        {name: "è¶Šå—", url: "https://proxyip.881288.xyz/api/txt/VN"},
        {name: "å°å°¼", url: "https://proxyip.881288.xyz/api/txt/ID"},
        {name: "è²å¾‹å®¾", url: "https://proxyip.881288.xyz/api/txt/PH"},
        {name: "ç¼…ç”¸", url: "https://proxyip.881288.xyz/api/txt/MM"},
        {name: "è€æŒ", url: "https://proxyip.881288.xyz/api/txt/LA"},
        {name: "æŸ¬åŸ”å¯¨", url: "https://proxyip.881288.xyz/api/txt/KH"},
        {name: "å­ŸåŠ æ‹‰", url: "https://proxyip.881288.xyz/api/txt/BD"},
        {name: "å°åº¦", url: "https://proxyip.881288.xyz/api/txt/IN"},
        {name: "å·´åŸºæ–¯å¦", url: "https://proxyip.881288.xyz/api/txt/PK"},
        {name: "æ–‡è±", url: "https://proxyip.881288.xyz/api/txt/BN"},
        {name: "åŠ æ‹¿å¤§", url: "https://proxyip.881288.xyz/api/txt/CA"},
        {name: "å¢¨è¥¿å“¥", url: "https://proxyip.881288.xyz/api/txt/MX"},
        {name: "å·´è¥¿", url: "https://proxyip.881288.xyz/api/txt/BR"},
        {name: "é˜¿æ ¹å»·", url: "https://proxyip.881288.xyz/api/txt/AR"},
        {name: "æ™ºåˆ©", url: "https://proxyip.881288.xyz/api/txt/CL"},
        {name: "å“¥ä¼¦æ¯”äºš", url: "https://proxyip.881288.xyz/api/txt/CO"},
        {name: "ç§˜é²", url: "https://proxyip.881288.xyz/api/txt/PE"},
        {name: "è‹±å›½", url: "https://proxyip.881288.xyz/api/txt/GB"},
        {name: "å¾·å›½", url: "https://proxyip.881288.xyz/api/txt/DE"},
        {name: "æ³•å›½", url: "https://proxyip.881288.xyz/api/txt/FR"},
        {name: "è·å…°", url: "https://proxyip.881288.xyz/api/txt/NL"},
        {name: "ä¿„ç½—æ–¯", url: "https://proxyip.881288.xyz/api/txt/RU"},
        {name: "æ„å¤§åˆ©", url: "https://proxyip.881288.xyz/api/txt/IT"},
        {name: "è¥¿ç­ç‰™", url: "https://proxyip.881288.xyz/api/txt/ES"},
        {name: "åœŸè€³å…¶", url: "https://proxyip.881288.xyz/api/txt/TR"},
        {name: "æ³¢å…°", url: "https://proxyip.881288.xyz/api/txt/PL"},
        {name: "ä¹Œå…‹å…°", url: "https://proxyip.881288.xyz/api/txt/UA"},
        {name: "ç‘å…¸", url: "https://proxyip.881288.xyz/api/txt/SE"},
        {name: "èŠ¬å…°", url: "https://proxyip.881288.xyz/api/txt/FI"},
        {name: "æŒªå¨", url: "https://proxyip.881288.xyz/api/txt/NO"},
        {name: "ä¸¹éº¦", url: "https://proxyip.881288.xyz/api/txt/DK"},
        {name: "æ·å…‹", url: "https://proxyip.881288.xyz/api/txt/CZ"},
        {name: "ç½—é©¬å°¼äºš", url: "https://proxyip.881288.xyz/api/txt/RO"},
        {name: "ç‘å£«", url: "https://proxyip.881288.xyz/api/txt/CH"},
        {name: "è‘¡è„ç‰™", url: "https://proxyip.881288.xyz/api/txt/PT"},
        {name: "æ¾³å¤§åˆ©äºš", url: "https://proxyip.881288.xyz/api/txt/AU"},
        {name: "æ–°è¥¿å…°", url: "https://proxyip.881288.xyz/api/txt/NZ"},
        {name: "å—é", url: "https://proxyip.881288.xyz/api/txt/ZA"},
        {name: "åŸƒåŠ", url: "https://proxyip.881288.xyz/api/txt/EG"},
        {name: "å°¼æ—¥åˆ©äºš", url: "https://proxyip.881288.xyz/api/txt/NG"},
        {name: "æ²™ç‰¹", url: "https://proxyip.881288.xyz/api/txt/SA"},
        {name: "é˜¿è”é…‹", url: "https://proxyip.881288.xyz/api/txt/AE"},
        {name: "ä»¥è‰²åˆ—", url: "https://proxyip.881288.xyz/api/txt/IL"},
        {name: "ä¼Šæœ—", url: "https://proxyip.881288.xyz/api/txt/IR"},
        {name: "ä¼Šæ‹‰å…‹", url: "https://proxyip.881288.xyz/api/txt/IQ"}
    ];

    regionsData.forEach(r => {
        const opt1 = document.createElement('option');
        opt1.value = r.url;
        opt1.innerText = r.name;
        regionSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = r.url;
        opt2.innerText = r.name;
        genRegionSelect.appendChild(opt2);
    });

    function updateLineNumbers() {
        const val = inputArea.value;
        const lineCount = val.length > 0 ? val.split('\n').length : 1;
        lineNumbers.innerHTML = Array.from({length: lineCount}, (_, i) => i + 1).join('\n');
    }

    function syncScroll() {
        lineNumbers.scrollTop = inputArea.scrollTop;
    }

    inputArea.addEventListener('input', updateLineNumbers);
    inputArea.addEventListener('scroll', syncScroll);
    inputArea.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const cleanText = text.split('\n').map(line => line.trim()).filter(line => line).join('\n');
        document.execCommand('insertText', false, cleanText);
    });

    updateLineNumbers();

    function openModal() { modal.style.display = 'flex'; subInput.focus(); }
    function closeModal() { modal.style.display = 'none'; subInput.value = ''; regionSelect.value = ""; }

    async function handleRegionChange() {
        const url = regionSelect.value;
        if (!url) return;
        currentRegionName = ""; 
        subInput.value = url;
        await fetchSub(true);
        regionSelect.value = ""; 
    }

    async function handleGenShortcut() {
        const url = genRegionSelect.value;
        if (!url) return;
        
        inputArea.value = '';
        validList = [];
        resetManualConfig();

        const index = genRegionSelect.selectedIndex;
        currentRegionName = genRegionSelect.options[index].text;

        const statusBox = document.getElementById('genStatusBox');
        const selectBox = document.getElementById('genRegionSelect');
        
        statusBox.style.display = 'flex';
        statusBox.innerHTML = `<span>â³ æ­£åœ¨è·å– ${currentRegionName} æ•°æ®å¹¶éªŒè¯...</span>`;
        selectBox.style.display = 'none';

        try {
            const res = await fetch(`${FETCH_URL}?url=${encodeURIComponent(url)}&t=${Date.now()}`);
            if (!res.ok) throw new Error('Network error');
            const text = await res.text();
            
            const ips = parseSubscription(text);
            if (ips.length === 0) {
                showToast(`è¯¥åœ°åŒº(${currentRegionName})æš‚æ— å¯ç”¨æ•°æ®`, '#f59e0b', 4000);
                statusBox.style.display = 'none';
                selectBox.style.display = 'block';
                selectBox.value = "";
                showNoDataModal();
                resetManualConfig();
                return;
            }

            inputArea.value = ips.join('\n'); 
            updateLineNumbers();

            const count = await scan(true);

            if(count > 0) {
                statusBox.innerHTML = `<span>âœ… å·²è·å– ${count} ä¸ªæœ‰æ•ˆIP (${currentRegionName})</span>`;
                if (validList.length > 0) {
                    const firstNode = validList[0];
                    updateManualConfig(firstNode.ip, firstNode.port, currentRegionName);
                }
            } else {
                statusBox.innerHTML = `<span>âš ï¸ æœªå‘ç°æœ‰æ•ˆèŠ‚ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–åœ°åŒº</span>`;
                resetManualConfig();
                setTimeout(() => {
                    statusBox.style.display = 'none';
                    selectBox.style.display = 'block';
                    selectBox.value = "";
                }, 3000);
            }

        } catch (e) {
            showToast('å¤„ç†å¤±è´¥: ' + e.message, '#f87171');
            statusBox.style.display = 'none';
            selectBox.style.display = 'block';
            selectBox.value = "";
            resetManualConfig();
        }
    }

    async function fetchSub(isRegion = false) {
        const url = subInput.value.trim();
        if (!url) return showToast('è¯·è¾“å…¥é“¾æ¥', '#f87171');
        
        const btn = document.getElementById('btnExtract');
        const originalText = btn.innerText;
        btn.innerText = 'æå–ä¸­...';
        btn.disabled = true;

        try {
            const res = await fetch(`${FETCH_URL}?url=${encodeURIComponent(url)}&t=${Date.now()}`);
            if (!res.ok) throw new Error('Network error');
            const text = await res.text();
            
            const ips = parseSubscription(text);
            if (ips.length === 0) {
                if (isRegion) {
                    showNoDataModal();
                } else {
                    showToast('æœªæå–åˆ°æœ‰æ•ˆèŠ‚ç‚¹ IP', '#f59e0b');
                }
            } else {
                inputArea.value = ips.join('\n');
                updateLineNumbers();
                closeModal();
                showToast(`æå–åˆ° ${ips.length} ä¸ªåœ°å€`, '#10b981');
                setTimeout(scan, 500);
            }
        } catch (e) {
            showToast('æå–å¤±è´¥: ' + e.message, '#f87171');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function parseSubscription(content) {
        content = content.trim();
        let decoded = content;
        try {
            let temp = atob(content.replace(/\s/g, ''));
            decoded = decodeURIComponent(escape(temp));
        } catch (e) {}

        const result = new Set();
        const scanText = (text) => {
            const lines = text.split(/[\r\n]+/);
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                if (line.startsWith('vmess://')) {
                    try {
                        const b64 = line.substring(8);
                        const jsonStr = decodeURIComponent(escape(atob(b64)));
                        const obj = JSON.parse(jsonStr);
                        if (obj.add && obj.port) result.add(`${obj.add}:${obj.port}`);
                    } catch (e) {}
                } else if (line.startsWith('vless://') || line.startsWith('trojan://')) {
                    const match = line.match(/@([^:]+):(\d+)/);
                    if (match && match[1] && match[2]) result.add(`${match[1]}:${match[2]}`);
                }
            });
            const ipv4Regex = /(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?):(?:\d{1,5})/g;
            const v4Matches = text.match(ipv4Regex);
            if (v4Matches) v4Matches.forEach(ip => result.add(ip));
            const ipv6Regex = /\[([a-fA-F0-9:]+)\]:(?:\d{1,5})/g;
            const v6Matches = text.match(ipv6Regex);
            if (v6Matches) v6Matches.forEach(ip => result.add(ip));
        };
        scanText(decoded);
        if (content !== decoded) scanText(content);
        return Array.from(result);
    }

    async function scan(silentMode = false) {
        const txt = inputArea.value;
        let rawList = txt.split('\n').map(s => s.trim()).filter(s => s);
        
        if (rawList.length === 0) {
            if(!silentMode) showToast('è¯·è¾“å…¥ IP åˆ—è¡¨', '#f87171');
            return 0;
        }

        const ips = [...new Set(rawList)];
        const duplicatesRemoved = rawList.length - ips.length;

        let btn = null;
        if(!silentMode) {
             btn = document.getElementById('btnScan');
             btn.disabled = true;
             btn.innerHTML = '<span style="animation:spin 1s linear infinite">âš¡</span> æ‰«æä¸­...';
        }
        
        if(!silentMode) {
            let statusMsg = `å¤„ç† ${ips.length} ä¸ªèŠ‚ç‚¹...`;
            if (duplicatesRemoved > 0) statusMsg += ` (å»é‡ ${duplicatesRemoved})`;
            document.getElementById('status').innerText = statusMsg;
            document.getElementById('status').style.color = "var(--accent-primary)";
            
            document.getElementById('list').innerHTML = '';
            document.getElementById('tableBox').style.display = 'none';
            document.getElementById('emptyMsg').style.display = 'none';
            const bottomBar = document.getElementById('bottomBar');
            if(bottomBar) bottomBar.style.display = 'none';
        }
        validList = [];

        const start = Date.now();
        let validCount = 0;
        
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ips})
            });
            const json = await res.json();
            const time = ((Date.now() - start)/1000).toFixed(2);

            const good = json.data.filter(r => r.valid).sort((a,b) => a.latency - b.latency);

            validList = good;
            validCount = good.length;

            if(!silentMode) {
                const tbody = document.getElementById('list');
                if (good.length > 0) {
                    good.forEach((r, i) => {
                        const tr = document.createElement('tr');
                        tr.style.animation = `fadeIn 0.3s ease forwards ${i * 0.05}s`;
                        tr.style.opacity = '0'; 
                        tr.onclick = function() { copyText(r.ip + ':' + r.port); };
                        let latClass = r.latency < 100 ? 'fast' : (r.latency < 200 ? 'mid' : 'slow');
                        let colo = r.colo === 'UNK' ? '??' : r.colo;
                        let pIcon = r.is_p ? '<span class="check-icon">âœ…</span>' : '<span class="cross-icon">Ã—</span>';
                        let fIcon = r.is_f ? '<span class="check-icon">âœ…</span>' : '<span class="cross-icon">Ã—</span>';
                        tr.innerHTML = `<td>${i + 1}</td><td class="ip-cell">${r.ip}:${r.port}</td><td><span class="colo-badge">${colo}</span></td><td><span class="lat-badge ${latClass}">${r.latency}ms</span></td><td>${pIcon}</td><td>${fIcon}</td>`;
                        tbody.appendChild(tr);
                    });
                    document.getElementById('tableBox').style.display = 'block';
                    const bottomBar = document.getElementById('bottomBar');
                    if(bottomBar) bottomBar.style.display = 'block';
                } else {
                    document.getElementById('emptyMsg').style.display = 'block';
                    document.getElementById('emptyMsg').innerText = "æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„æœ‰æ•ˆèŠ‚ç‚¹";
                }
                document.getElementById('status').innerText = `å®Œæˆ (è€—æ—¶ ${time}s)`;
                document.getElementById('status').style.color = "#10b981";
                document.getElementById('validCount').innerText = good.length;
            }
        } catch(e) {
            if(!silentMode) {
                showToast('è¯·æ±‚å¤±è´¥', '#f87171');
                document.getElementById('status').innerText = 'é”™è¯¯';
                document.getElementById('status').style.color = "#f87171";
            }
        }
        
        if(!silentMode) {
            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ å¼€å§‹æ‰«æ';
        }

        return validCount;
    }

    function generateSub(type) {
        if (validList.length === 0) return showToast("å½“å‰æ— æœ‰æ•ˆèŠ‚ç‚¹", "#f87171");
        
        const inputHost = document.getElementById('genHost').value.trim();
        const inputUuid = document.getElementById('genUuid').value.trim();
        const isCustom = inputHost !== "" || inputUuid !== "";

        let host, uuid;
        
        host = inputHost || GlobalHost;
        uuid = inputUuid || GlobalUUID;

        if (!host || !uuid) {
            return showToast("æœªé…ç½®èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜", "#f87171");
        }

        const limit = parseInt(document.getElementById('genLimit').value);
        
        let pathPrefix = "";
        if (isCustom) {
            if (type === 'trojan') {
                if (!confirm("å¦‚æœä½ çš„ä»£ç ä¸æ”¯æŒTrojanè¯·ç”Ÿæˆvlessè®¢é˜…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) {
                    return;
                }
            }
            
            if (proxyFormatSelect.value === 'custom') {
                pathPrefix = document.getElementById('customProxyFormat').value.trim();
            } else {
                pathPrefix = proxyFormatSelect.value;
            }
        } else {
            pathPrefix = "";
        }

        const targetList = validList.slice(0, limit);
        let nodes = [];
        let coloCounts = {};

        const coloMap = {
            "NRT":"JP", "KIX":"JP", "FUK":"JP", "NGO":"JP", "HND":"JP",
            "ICN":"KR", "HKG":"HK", "TPE":"TW", "KHH":"TW", "SIN":"SG",
            "LAX":"US", "SJC":"US", "SFO":"US", "JFK":"US", "EWR":"US", "ORD":"US", "DFW":"US", "SEA":"US", "MIA":"US", "IAD":"US", "ATL":"US", "PHX":"US", "DEN":"US", "LAS":"US",
            "LHR":"GB", "MAN":"GB", "EDI":"GB", "AMS":"NL", "FRA":"DE", "MUC":"DE", "DUS":"DE", "HAM":"DE", "TXL":"DE", "CDG":"FR", "MRS":"FR", "LYS":"FR",
            "YYZ":"CA", "YVR":"CA", "YUL":"CA", "SYD":"AU", "MEL":"AU", "BNE":"AU", "PER":"AU",
            "VNO":"LT", "RIX":"LV", "TLL":"EE", "WAW":"PL", "PRG":"CZ", "VIE":"AT", "ZRH":"CH", "MAD":"ES", "BCN":"ES", "MXP":"IT", "FCO":"IT",
            "GRU":"BR", "GIG":"BR", "EZE":"AR", "SCL":"CL", "BOG":"CO", "LIM":"PE", "JNB":"ZA", "CPT":"ZA", "DXB":"AE", "RUH":"SA", "TLV":"IL", "BOM":"IN", "DEL":"IN"
        };

        targetList.forEach((r, index) => {
            let name = "";
            if (currentRegionName) {
                name = `${index + 1}ã€${currentRegionName}`;
            } else {
                let colo = r.colo || 'UNK';
                if(coloMap[colo]) colo = coloMap[colo];
                
                coloCounts[colo] = (coloCounts[colo] || 0) + 1;
                name = `${coloCounts[colo]}ã€${colo}`;
            }
            let encodedName = encodeURIComponent(name);
            
            let nodeAddr = r.ip;
            if (r.ip.includes(':')) nodeAddr = `[${r.ip}]`;
            
            let pathVal = "";
            if (isCustom && pathPrefix) {
                pathVal = `${pathPrefix}${r.ip}:${r.port}`;
            } else {
                pathVal = `/${r.ip}:${r.port}`;
            }
            let encodedPath = encodeURIComponent(pathVal);

            if (type === 'vless') {
                let link = `vless://${uuid}@${nodeAddr}:${r.port}?encryption=none&security=tls&sni=${host}&fp=randomized&insecure=0&allowInsecure=0&type=ws&host=${host}&path=${encodedPath}#${encodedName}`;
                nodes.push(link);
            } else if (type === 'trojan') {
                let password = uuid.split('-')[0];
                let link = `trojan://${password}@${nodeAddr}:${r.port}?security=tls&sni=${host}&fp=randomized&insecure=0&allowInsecure=0&type=ws&host=${host}&path=${encodedPath}#${encodedName}`;
                nodes.push(link);
            } else if (type === 'ss') {
                let password = `none:${uuid}`;
                let bPass = btoa(password);
                let pluginParams = `v2ray-plugin;mode=websocket;host=${host};path=${pathVal};tls`;
                let encodedPluginParams = encodeURIComponent(pluginParams);
                let link = `ss://${bPass}@${nodeAddr}:${r.port}?plugin=${encodedPluginParams}#${encodedName}`;
                nodes.push(link);
            }
        });

        const fullText = nodes.join('\n');
        const base64 = btoa(fullText);

        const resBox = document.getElementById('genResult');
        resBox.value = "ç”Ÿæˆä¸­...";

        fetch(STORE_URL, {
            method: 'POST',
            body: base64
        }).then(res => res.json()).then(data => {
            if(data.id) {
                const origin = window.location.origin;
                const finalLink = `${origin}/${data.id}`;
                resBox.value = finalLink;
                copyText(finalLink);
                showToast("è®¢é˜…å·²ç”Ÿæˆå¹¶è‡ªåŠ¨å¤åˆ¶ï¼", "#3b82f6");
            }
        }).catch(err => {
            resBox.value = "ç”Ÿæˆå¤±è´¥";
            showToast("å­˜å‚¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²é‡å¯", "#f87171");
        });
    }

    function copyGenResult() {
        const input = document.getElementById('genResult');
        if (input.value && input.value !== "ç”Ÿæˆä¸­..." && input.value !== "ç”Ÿæˆå¤±è´¥") {
            copyText(input.value);
        }
    }

    function copyText(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => { triggerToast(text); }).catch(err => { fallbackCopy(text); });
        } else { fallbackCopy(text); }
    }

    function fallbackCopy(text) {
        try {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            if (successful) triggerToast(text);
            else showToast('å¤åˆ¶å¤±è´¥', '#f87171');
        } catch (err) { showToast('å¤åˆ¶å¤±è´¥', '#f87171'); }
    }

    function triggerToast(text) {
        const color = toastColors[Math.floor(Math.random() * toastColors.length)];
        showToast(`å·²å¤åˆ¶: ${text}`, color);
    }

    function copyAll() {
        if (validList.length === 0) return;
        const text = validList.map(r => `${r.ip}:${r.port}`).join('\n');
        copyText(text);
        showToast(`å·²å¤åˆ¶ ${validList.length} ä¸ªèŠ‚ç‚¹`, '#10b981');
    }

    function showToast(msg, color, duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.background = color;
        if(msg.length > 30 && !msg.includes('èŠ‚ç‚¹') && !msg.includes('åœ°åŒº')) msg = msg.substring(0, 28) + '...';
        toast.innerHTML = `<span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('hide');
            setTimeout(() => { if(toast.parentNode) toast.parentNode.removeChild(toast); }, 400); 
        }, duration); 
    }

    function clearAll() {
        inputArea.value = '';
        currentRegionName = ""; 
        document.getElementById('genRegionSelect').style.display = 'block';
        document.getElementById('genStatusBox').style.display = 'none';
        genRegionSelect.value = "";
        
        updateLineNumbers();
        document.getElementById('list').innerHTML = '';
        document.getElementById('validCount').innerText = '0';
        document.getElementById('status').innerText = 'å°±ç»ª';
        document.getElementById('status').style.color = "var(--text-secondary)";
        
        const bottomBar = document.getElementById('bottomBar');
        if(bottomBar) bottomBar.style.display = 'none';
        
        document.getElementById('tableBox').style.display = 'none';
        document.getElementById('emptyMsg').style.display = 'none';
        resetManualConfig(); 
    }
    
    // å¼ºåˆ¶ç­‰å¾…é¡µé¢èµ„æºåŠ è½½å®Œæ¯•åå†æ‰§è¡Œ
    window.addEventListener('load', function() {
        initApp();
    });
</script>
<style>
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes fadeIn { to { opacity: 1; } }
</style>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"86a95e44dfb44b2a81ee4d4a49845b20","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
